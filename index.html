<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ QR ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDoc, getDocs,
  collection, addDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ===== FIREBASE ===== */
const firebaseConfig = {
  apiKey: "AIzaSyD19ffZKxxXfWj9sseK66LCCVEWqGNqPPI",
  authDomain: "appsk-7f523.firebaseapp.com",
  projectId: "appsk-7f523",
  storageBucket: "appsk-7f523.appspot.com",
  messagingSenderId: "543787580025",
  appId: "1:543787580025:web:10772d30a3fdbf88afb2a8"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ===== NAV ===== */
window.show = id=>{
 ["student","teacher","scanTeacher","admin"].forEach(x=>{
  document.getElementById(x).classList.add("hidden")
 })
 document.getElementById(id).classList.remove("hidden")
}

/* ===== STUDENT LOGIN ===== */
window.studentLogin = async ()=>{
 let sid = stuId.value
 let snap = await getDoc(doc(db,"students",sid))
 if(!snap.exists()){ alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"); return }
 let s = snap.data()

 stuArea.innerHTML=`
 <b>‡∏ä‡∏∑‡πà‡∏≠:</b> ${s.name}<br>
 <b>‡∏ä‡∏±‡πâ‡∏ô:</b> ‡∏°.${s.level}/${s.room}
 <div id="qrcode"></div>
 `
 new QRCode(document.getElementById("qrcode"), sid)
}

/* ===== TEACHER LOGIN ===== */
window.teacherLogin = async ()=>{
 let snap = await getDoc(doc(db,"teachers",tUser.value))
 if(!snap.exists() || snap.data().pass!=tPass.value){
  alert("‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"); return
 }

 let subs = await getDocs(collection(db,"subjects"))
 let opts=""
 subs.forEach(d=>opts+=`<option>${d.id}</option>`)

 teacherArea.innerHTML=`
 <b>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß</b><br><br>

 ‡∏ß‡∏¥‡∏ä‡∏≤:
 <select id="sub">${opts}</select>
 ‡∏ä‡∏±‡πâ‡∏ô:
 <select id="level">
  <option>1</option><option>2</option><option>3</option>
  <option>4</option><option>5</option><option>6</option>
 </select>
 ‡∏´‡πâ‡∏≠‡∏á:
 <select id="room">
  <option>1</option><option>2</option><option>3</option><option>4</option>
 </select>

 <h4>üì∑ ‡∏™‡πÅ‡∏Å‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
 <div id="reader" style="width:280px"></div>
 <button onclick="startScan()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô</button>
 <div id="result"></div>

 <hr>
 <h4>üÜï QR ‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡πÅ‡∏Å‡∏ô (5 ‡∏ô‡∏≤‡∏ó‡∏µ)</h4>
 <button onclick="createTeacherQR()">‡∏™‡∏£‡πâ‡∏≤‡∏á QR</button>
 <div id="teacherQR"></div>
 `
}

/* ===== SCAN STUDENT ===== */
window.startScan = ()=>{
 let qr=new Html5Qrcode("reader")
 qr.start({facingMode:"environment"},{fps:10},async txt=>{
  qr.stop()
  let sSnap=await getDoc(doc(db,"students",txt))
  if(!sSnap.exists()){alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");return}
  let s=sSnap.data()

  await addDoc(collection(db,"attendance"),{
    sid:txt,
    name:s.name,
    level:s.level,
    room:s.room,
    subject:sub.value,
    status:"‡∏°‡∏≤",
    time:new Date().toLocaleString()
  })

  result.innerHTML=`‚úÖ ${s.name} ‡∏°.${s.level}/${s.room} ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß`
 })
}

/* ===== CREATE TEACHER QR ===== */
window.createTeacherQR = async ()=>{
 let expire = Date.now()+5*60*1000
 let ref = await addDoc(collection(db,"teacherQR"),{
  subject:sub.value,
  level:level.value,
  room:room.value,
  expireAt:expire
 })
 teacherQR.innerHTML=`
 <p>‚è± ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ 5 ‡∏ô‡∏≤‡∏ó‡∏µ</p>
 <div id="qrTeacher"></div>
 `
 new QRCode(document.getElementById("qrTeacher"), ref.id)
}

/* ===== STUDENT SCAN TEACHER ===== */
window.startScanTeacher = ()=>{
 let qr=new Html5Qrcode("reader2")
 qr.start({facingMode:"environment"},{fps:10},async txt=>{
  qr.stop()
  let snap=await getDoc(doc(db,"teacherQR",txt))
  if(!snap.exists()){scanResult.innerHTML="‚ùå QR ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";return}
  let d=snap.data()
  let status="‡∏°‡∏≤"

  if(Date.now()>d.expireAt){
   if(confirm("‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")){
    status="‡∏™‡∏≤‡∏¢"
   }else return
  }

  await addDoc(collection(db,"attendance"),{
    sid:stuId2.value,
    subject:d.subject,
    level:d.level,
    room:d.room,
    status,
    time:new Date().toLocaleString()
  })

  scanResult.innerHTML=`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß (${status})`
 })
}

/* ===== ADMIN ===== */
window.adminLogin = ()=>{
 if(adminPass.value!="1669"){alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î");return}
 adminArea.innerHTML=`
 <h4>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
 <input id="sid" placeholder="‡∏£‡∏´‡∏±‡∏™" inputmode="numeric">
 <input id="sname" placeholder="‡∏ä‡∏∑‡πà‡∏≠">
 <input id="slevel" placeholder="‡∏°." inputmode="numeric">
 <input id="sroom" placeholder="‡∏´‡πâ‡∏≠‡∏á" inputmode="numeric">
 <input type="file" accept="image/*" onchange="loadPhoto(event)">
 <img id="preview" height="80"><br>
 <button onclick="addStudent()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>

 <h4>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π</h4>
 <input id="tname" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π">
 <input id="tpass" placeholder="‡∏£‡∏´‡∏±‡∏™" inputmode="numeric">
 <button onclick="addTeacher()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π</button>

 <h4>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤</h4>
 <input id="subj">
 <button onclick="addSubject()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤</button>
 `
}

let photo=""
window.loadPhoto=e=>{
 let r=new FileReader()
 r.onload=()=>{photo=r.result;preview.src=photo}
 r.readAsDataURL(e.target.files[0])
}

window.addStudent=async()=>{
 await setDoc(doc(db,"students",sid.value),{
  name:sname.value,level:slevel.value,room:sroom.value,photo
 })
 alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß")
}
window.addTeacher=async()=>{
 await setDoc(doc(db,"teachers",tname.value),{pass:tpass.value})
 alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π‡πÅ‡∏•‡πâ‡∏ß")
}
window.addSubject=async()=>{
 await setDoc(doc(db,"subjects",subj.value),{})
 alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡πâ‡∏ß")
}
</script>

<style>
body{font-family:sans-serif;background:#f3e8ff;padding:20px}
.menu button{margin:5px;padding:10px;background:#7c3aed;color:#fff;border:none;border-radius:8px}
.box{background:#fff;padding:15px;border-radius:10px;margin-top:10px}
.hidden{display:none}
</style>
</head>

<body>

<h2>üè´ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ QR ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h2>

<div class="menu">
 <button onclick="show('student')">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
 <button onclick="show('teacher')">‡∏Ñ‡∏£‡∏π</button>
 <button onclick="show('scanTeacher')">‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏£‡∏π</button>
 <button onclick="show('admin')">‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</button>
</div>

<div id="student" class="box hidden">
 <h3>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
 <input id="stuId" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" inputmode="numeric">
 <button onclick="studentLogin()">‡πÄ‡∏Ç‡πâ‡∏≤</button>
 <div id="stuArea"></div>
</div>

<div id="scanTeacher" class="box hidden">
 <h3>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏£‡∏π</h3>
 <input id="stuId2" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" inputmode="numeric">
 <div id="reader2" style="width:280px"></div>
 <button onclick="startScanTeacher()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô</button>
 <div id="scanResult"></div>
</div>

<div id="teacher" class="box hidden">
 <h3>‡∏Ñ‡∏£‡∏π</h3>
 <input id="tUser" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π">
 <input id="tPass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" inputmode="numeric">
 <button onclick="teacherLogin()">‡πÄ‡∏Ç‡πâ‡∏≤</button>
 <div id="teacherArea"></div>
</div>

<div id="admin" class="box hidden">
 <h3>‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</h3>
 <input id="adminPass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" inputmode="numeric">
 <button onclick="adminLogin()">‡πÄ‡∏Ç‡πâ‡∏≤</button>
 <div id="adminArea"></div>
</div>

</body>
</html>
