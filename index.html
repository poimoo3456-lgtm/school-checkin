<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ QR ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- QR -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<style>
body{font-family:sans-serif;background:#f3e8ff;color:#4b006e}
.box{background:#fff;padding:15px;margin:10px;border-radius:10px}
button{padding:8px;margin:4px;background:#7c3aed;color:#fff;border:none;border-radius:6px}
input{padding:6px;margin:4px}
.hide{display:none}
</style>
</head>
<body>

<h1>üìö ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ QR</h1>

<!-- ====== ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö ====== -->
<div class="box">
<button onclick="show('admin')">‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</button>
<button onclick="show('teacher')">‡∏Ñ‡∏£‡∏π</button>
<button onclick="show('student')">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
</div>

<!-- ====== ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô ====== -->
<div id="admin" class="box hide">
<h2>üõ† ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</h2>
<input id="adminPass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô">
<button onclick="loginAdmin()">‡πÄ‡∏Ç‡πâ‡∏≤</button>

<div id="adminPanel" class="hide">
<h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
<ul id="history"></ul>
</div>
</div>

<!-- ====== ‡∏Ñ‡∏£‡∏π ====== -->
<div id="teacher" class="box hide">
<h2>üë®‚Äçüè´ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏π</h2>
<input id="subject" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤">
<button onclick="createQR()">‡∏™‡∏£‡πâ‡∏≤‡∏á QR (5 ‡∏ô‡∏≤‡∏ó‡∏µ)</button>
<div id="qrcode"></div>
</div>

<!-- ====== ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ====== -->
<div id="student" class="box hide">
<h2>üßë‚Äçüéì ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
<input id="sname" placeholder="‡∏ä‡∏∑‡πà‡∏≠">
<input id="sclass" placeholder="‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á"><br>
<button onclick="checkIn(false)">‡∏°‡∏≤</button>
<button onclick="checkIn(true)">‡∏™‡∏≤‡∏¢</button>
</div>

<script>
/* ===== Firebase config ===== */
firebase.initializeApp({
  apiKey: "AIzaSyD19ffZKxxXfWj9sseK66LCCVEWqGNqPPI",
  authDomain: "appsk-7f523.firebaseapp.com",
  projectId: "appsk-7f523"
});
const db = firebase.firestore();

/* ===== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ===== */
function show(id){
  document.querySelectorAll('.box').forEach(b=>b.classList.add('hide'));
  document.getElementById(id).classList.remove('hide');
}

/* ===== ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô ===== */
function loginAdmin(){
  if(adminPass.value==="1669"){
    adminPanel.classList.remove("hide");
    loadHistory();
    alert("‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
  }else alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î");
}

function loadHistory(){
  db.collection("attendance").orderBy("time","desc")
  .onSnapshot(snap=>{
    history.innerHTML="";
    snap.forEach(d=>{
      const x=d.data();
      history.innerHTML+=`<li>${x.name} | ${x.class} | ${x.subject} | ${x.late?"‡∏™‡∏≤‡∏¢":"‡∏°‡∏≤"}</li>`;
    });
  });
}

/* ===== ‡∏Ñ‡∏£‡∏π ===== */
function createQR(){
  const exp = Date.now()+5*60*1000;
  db.collection("activeQR").doc("current").set({
    subject:subject.value,
    expire:exp
  });

  qrcode.innerHTML="";
  new QRCode(qrcode,"ACTIVE");
  alert("‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‡πÅ‡∏•‡πâ‡∏ß");
}

/* ===== ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ===== */
async function checkIn(late){
  const qr = await db.collection("activeQR").doc("current").get();
  if(!qr.exists) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ QR");

  const d=qr.data();
  if(Date.now()>d.expire) return alert("QR ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏");

  db.collection("attendance").add({
    name:sname.value,
    class:sclass.value,
    subject:d.subject,
    late:late,
    time:firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß");
}
</script>

</body>
</html>
