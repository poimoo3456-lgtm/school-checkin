<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ QR ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<style>
body{
  font-family:sans-serif;
  background:linear-gradient(135deg,#ede7f6,#d1c4e9);
  padding:20px
}
.box{
  background:#fff;
  padding:15px;
  border-radius:16px;
  margin-bottom:15px;
  box-shadow:0 8px 20px rgba(0,0,0,.15)
}
button{
  padding:8px 16px;
  margin:5px;
  border:none;
  border-radius:12px;
  background:#7e57c2;
  color:#fff;
  font-size:14px;
  cursor:pointer
}
button:hover{opacity:.9}
input,select{
  padding:7px;
  margin:5px;
  border-radius:10px;
  border:1px solid #bbb;
  font-size:14px
}
.hidden{display:none}
img{border-radius:12px}

/* ‡∏ö‡∏±‡∏ï‡∏£ */
.card{
  width:330px;
  background:linear-gradient(135deg,#7e57c2,#ede7f6);
  border-radius:22px;
  padding:15px;
}
.card-inner{
  background:#fff;
  border-radius:18px;
  padding:12px;
  text-align:center
}
.card-inner h3{color:#5e35b1;margin:6px}
.photo{
  width:100px;height:120px;
  object-fit:cover;
  border-radius:12px;
  border:3px solid #7e57c2
}
small{color:#555}
</style>
</head>

<body>

<h2 id="schoolName">üè´ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
<img id="schoolLogo" height="60">

<div class="box">
  <button onclick="show('student')">üë®‚Äçüéì ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
  <button onclick="show('teacher')">üë©‚Äçüè´ ‡∏Ñ‡∏£‡∏π</button>
  <button onclick="show('admin')">‚öôÔ∏è ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</button>
</div>

<!-- ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô -->
<div id="student" class="box hidden">
<h3>‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
<input id="stuId" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" inputmode="numeric">
<button onclick="studentLogin()">‡πÄ‡∏Ç‡πâ‡∏≤</button>
<div id="stuArea"></div>
</div>

<!-- ‡∏Ñ‡∏£‡∏π -->
<div id="teacher" class="box hidden">
<h3>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏π</h3>
<input id="tUser" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π">
<input id="tPass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" inputmode="numeric">
<button onclick="teacherLogin()">‡πÄ‡∏Ç‡πâ‡∏≤</button>
<div id="teacherArea"></div>
</div>

<!-- Admin -->
<div id="admin" class="box hidden">
<h3>‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</h3>
<input id="adminPass" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" inputmode="numeric">
<button onclick="adminLogin()">‡πÄ‡∏Ç‡πâ‡∏≤</button>
<div id="adminArea"></div>
</div>

<script>
let db = JSON.parse(localStorage.getItem("db")) || {
  school:"‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á",
  logo:"",
  students:{},
  teachers:{},
  subjects:{},
  attendance:[]
}
function save(){localStorage.setItem("db",JSON.stringify(db))}

schoolName.innerText="üè´ "+db.school
schoolLogo.src=db.logo

function show(id){
  ["student","teacher","admin"].forEach(x=>document.getElementById(x).classList.add("hidden"))
  document.getElementById(id).classList.remove("hidden")
}

/* ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô */
function studentLogin(){
  let s=db.students[stuId.value]
  if(!s){alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");return}
  alert("‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß")

  stuArea.innerHTML=`
  <div class="card">
    <div class="card-inner">
      <img src="${db.logo}" height="40"><br>
      <small>${db.school}</small><hr>
      <img class="photo" src="${s.photo||''}">
      <h3>${s.name}</h3>
      <div>‡∏°.${s.level}/${s.room}</div>
      <div>‡∏£‡∏´‡∏±‡∏™ ${stuId.value}</div>
      <div id="qrcode"></div>
    </div>
  </div>

  <button onclick="window.print()">üñ® ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ï‡∏£</button>

  <h4>üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
  <ul>
  ${db.attendance.filter(a=>a.sid==stuId.value)
  .map(a=>`<li>${a.sub} | ‡∏°.${a.level}/${a.room} : ${a.status}</li>`).join("")}
  </ul>
  `
  new QRCode(document.getElementById("qrcode"),stuId.value)
}

/* ‡∏Ñ‡∏£‡∏π */
function teacherLogin(){
  let t=db.teachers[tUser.value]
  if(!t||t.pass!=tPass.value){alert("‚ùå ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ");return}
  alert("‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏£‡∏π‡πÅ‡∏•‡πâ‡∏ß")

  teacherArea.innerHTML=`
  <select id="sub">${Object.keys(db.subjects).map(s=>`<option>${s}</option>`).join("")}</select>
  <select id="level">${[1,2,3,4,5,6].map(i=>`<option>${i}</option>`).join("")}</select>
  <select id="room">${[1,2,3,4,5].map(i=>`<option>${i}</option>`).join("")}</select>

  <div id="reader" style="width:280px"></div>
  <button onclick="startScan()">üì∑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô</button>
  <div id="result"></div>
  `
}

function startScan(){
  let qr=new Html5Qrcode("reader")
  qr.start({facingMode:"environment"},{fps:10},txt=>{
    qr.stop()
    let s=db.students[txt]
    if(!s||s.level!=level.value||s.room!=room.value){
      alert("‚ùå ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á");return
    }
    let st=prompt("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏°‡∏≤ / ‡∏°‡∏≤‡∏™‡∏≤‡∏¢ / ‡∏Ç‡∏≤‡∏î / ‡∏•‡∏≤‡∏Å‡∏¥‡∏à / ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢")
    if(!st)return
    db.attendance.push({
      sid:txt,sub:sub.value,
      level:level.value,room:room.value,status:st,
      time:new Date().toLocaleString()
    })
    save()
    result.innerHTML="‚úî ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß"
  })
}

/* Admin */
function adminLogin(){
  if(adminPass.value!="1669"){alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î");return}
  alert("‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß")

  adminArea.innerHTML=`
  <h4>üè´ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
  <input placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" onchange="db.school=this.value;save();location.reload()">
  <input placeholder="‡πÇ‡∏•‡πÇ‡∏Å‡πâ URL" onchange="db.logo=this.value;save();location.reload()">

  <h4>üë®‚Äçüéì ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
  <input id="sid" placeholder="‡∏£‡∏´‡∏±‡∏™" inputmode="numeric">
  <input id="sname" placeholder="‡∏ä‡∏∑‡πà‡∏≠">
  <input id="slevel" placeholder="‡∏°." inputmode="numeric">
  <input id="sroom" placeholder="‡∏´‡πâ‡∏≠‡∏á" inputmode="numeric">
  <input type="file" accept="image/*" capture="camera" onchange="loadPhoto(event)">
  <br><img id="preview" height="120"><br>
  <button onclick="addStudent()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>

  <h4>üë©‚Äçüè´ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π</h4>
  <input id="tname" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π">
  <input id="tpass" placeholder="‡∏£‡∏´‡∏±‡∏™" inputmode="numeric">
  <button onclick="db.teachers[tname.value]={pass:tpass.value};save()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π</button>

  <h4>üìö ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</h4>
  <input id="subj">
  <button onclick="db.subjects[subj.value]=true;save()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤</button>

  <hr>
  <button style="background:#d32f2f" onclick="if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){localStorage.clear();location.reload()}">
  üóë ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö
  </button>
  `
}

let photoData=""
function loadPhoto(e){
  let r=new FileReader()
  r.onload=()=>{photoData=r.result;preview.src=photoData}
  r.readAsDataURL(e.target.files[0])
}

function addStudent(){
  db.students[sid.value]={
    name:sname.value,
    level:slevel.value,
    room:sroom.value,
    photo:photoData
  }
  save()
  alert("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")
}
</script>
</body>
</html>
