<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ QR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
 font-family:sans-serif;
 background:#f5f0ff;
 color:#4b2e83;
 margin:0;
}
header{
 background:#6a0dad;
 color:white;
 padding:15px;
 text-align:center;
}
section{padding:15px}
.card{
 background:white;
 border-radius:12px;
 padding:15px;
 margin-bottom:15px;
 box-shadow:0 2px 6px rgba(0,0,0,.1)
}
button{
 background:#6a0dad;
 color:white;
 border:none;
 padding:10px 15px;
 border-radius:8px;
 margin-top:5px;
}
input,select{
 width:100%;
 padding:8px;
 margin-top:5px;
}
.hidden{display:none}
</style>
</head>

<body>

<header>üìò ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</header>

<section class="card">
<h3>üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô (PIN 1669)</h3>
<input id="pin" placeholder="‡∏£‡∏´‡∏±‡∏™">
<button onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤</button>
</section>

<section id="admin" class="hidden">

<div class="card">
<h3>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
<input id="sname" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
<input id="slevel" placeholder="‡∏°.">
<input id="sroom" placeholder="‡∏´‡πâ‡∏≠‡∏á">
<input type="file" id="sphoto" accept="image/*">
<button onclick="addStudent()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
</div>

<div class="card">
<h3>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π</h3>
<input id="tname" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π">
<button onclick="addTeacher()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π</button>
</div>

<div class="card">
<h3>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤</h3>
<input id="subname" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤">
<button onclick="addSubject()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤</button>
</div>

<div class="card">
<h3>üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
<ul id="history"></ul>
</div>

</section>

<section class="card">
<h3>üë®‚Äçüè´ ‡∏Ñ‡∏£‡∏π‡∏™‡∏£‡πâ‡∏≤‡∏á QR</h3>
<button onclick="createQR()">‡∏™‡∏£‡πâ‡∏≤‡∏á QR (5 ‡∏ô‡∏≤‡∏ó‡∏µ)</button>
<p id="qrtext"></p>
</section>

<section class="card">
<h3>üéí ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡πÅ‡∏Å‡∏ô QR</h3>
<input id="qrinput" placeholder="‡∏ß‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™ QR">
<button onclick="scanQR()">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</button>
</section>

<script type="module">

// üî• Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
 getFirestore, collection, addDoc, getDocs, query, where
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
 apiKey: "AIzaSyD19ffZKxxXfWj9sseK66LCCVEWqGNqPPI",
 authDomain: "appsk-7f523.firebaseapp.com",
 projectId: "appsk-7f523",
 storageBucket: "appsk-7f523.appspot.com",
 messagingSenderId: "543787580025",
 appId: "1:543787580025:web:10772d30a3fdbf88afb2a8"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// üîê Login
window.login = ()=>{
 if(pin.value==="1669"){
  admin.classList.remove("hidden")
  alert("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß")
 }else alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î")
}

// ‚ûï Student
window.addStudent = async()=>{
 await addDoc(collection(db,"students"),{
  name:sname.value,
  level:slevel.value,
  room:sroom.value,
  photo:sphoto.files[0]?.name || ""
 })
 alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß")
}

// ‚ûï Teacher
window.addTeacher = async()=>{
 await addDoc(collection(db,"teachers"),{name:tname.value})
 alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π‡πÅ‡∏•‡πâ‡∏ß")
}

// ‚ûï Subject
window.addSubject = async()=>{
 await addDoc(collection(db,"subjects"),{name:subname.value})
 alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡πâ‡∏ß")
}

// üë®‚Äçüè´ Create QR
window.createQR = async()=>{
 const expire = Date.now()+5*60*1000
 const doc = await addDoc(collection(db,"qr_sessions"),{expire})
 qrtext.innerText = "QR CODE: "+doc.id
}

// üéí Scan QR
window.scanQR = async()=>{
 const q = query(collection(db,"qr_sessions"), where("__name__","==",qrinput.value))
 const snap = await getDocs(q)
 if(snap.empty){alert("QR ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");return}

 const data = snap.docs[0].data()
 if(Date.now()>data.expire){
  alert("‡∏™‡∏≤‡∏¢")
  status="‡∏™‡∏≤‡∏¢"
 }else{
  alert("‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß")
  status="‡∏°‡∏≤"
 }

 await addDoc(collection(db,"attendance"),{
  status,
  time:new Date()
 })
 loadHistory()
}

// üìä History
async function loadHistory(){
 history.innerHTML=""
 const snap = await getDocs(collection(db,"attendance"))
 snap.forEach(d=>{
  const li=document.createElement("li")
  li.textContent=`${d.data().status} - ${d.data().time.toDate()}`
  history.appendChild(li)
 })
}
loadHistory()

</script>

</body>
</html>
